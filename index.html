<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>תיעוד התערבויות/תקיפות</title>
  <style>
    :root{
      --bg:#f7f8fa; --card:#ffffff; --ink:#1f2a37; --muted:#6b7280;
      --prime:#0b3a6f; --prime-2:#0a2f59; --ring:#e5e7eb; --ok:#155724; --okbg:#d4edda;
      --err:#7f1d1d; --errbg:#fde2e2; --warn:#8a6d3b; --warnbg:#fff3cd;
      --chip:#eef2f7;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45}
    .banner{background:var(--prime);color:#fff;padding:14px 16px;border-radius:0 0 14px 14px;position:sticky;top:0;z-index:10;box-shadow:0 4px 10px rgba(0,0,0,.06)}
    .banner h1{margin:0;text-align:center;font-size:20px}
    .btn-icon{position:absolute;top:10px;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff;cursor:pointer}
    .btn-icon:hover{background:rgba(255,255,255,.16)}
    .btn-left{left:10px} .btn-right{right:10px}
    .container{max-width:820px;margin:22px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.04);padding:18px}
    label>span, legend{font-weight:600}
    input[type="text"],input[type="url"],input[type="date"],select,textarea{
      width:100%;margin-top:6px;padding:10px 12px;border:1px solid #cfd6df;border-radius:8px;font-size:15px;background:#fff;box-sizing:border-box
    }
    textarea{min-height:92px;resize:vertical}
    .hint{display:block;color:var(--muted);font-size:12px;margin-top:4px}
    .grid{display:grid;gap:14px}
    @media(min-width:720px){.cols-2{grid-template-columns:1fr 1fr}.cols-3{grid-template-columns:1fr 1fr 1fr}}
    fieldset{border:1px solid var(--ring);border-radius:10px;padding:12px 12px 8px;margin:0}
    legend{padding:0 6px;font-size:14px;color:var(--prime-2)}
    .checks{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    @media(min-width:720px){.checks{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .check{display:flex;align-items:center;gap:8px;background:var(--chip);border:1px solid #e8edf3;padding:6px 8px;border-radius:8px}
    .toolbar{display:flex;gap:8px;margin:6px 0 8px}
    .chipbtn{border:1px solid #cfd6df;background:#f9fbff;border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
    .chipbtn:hover{background:#eef5ff}
    button[type="submit"]{width:100%;padding:12px;border:0;border-radius:10px;background:var(--prime);color:#fff;font-weight:600;cursor:pointer}
    button[type="submit"]:hover{background:var(--prime-2)}
    #responseMessage{display:none;margin-top:12px;padding:10px 12px;border-radius:10px;text-align:center;font-weight:600}
    #responseMessage.success{background:var(--okbg);color:var(--ok);border:1px solid #c3e6cb}
    #responseMessage.error{background:var(--errbg);color:var(--err);border:1px solid #f5c6cb}
    .warning{display:none;margin:12px 0;padding:10px 12px;border-radius:10px;background:var(--warnbg);color:var(--warn);border:1px solid #ffeeba}
    dialog{border:0;border-radius:12px;max-width:520px;width:92%}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .close{background:#f2f2f2;border:1px solid #ddd;border-radius:8px;padding:2px 8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="banner">
    <button class="btn-icon btn-left" id="openInfo" title="מידע">i</button>
    <a href="#" class="btn-icon btn-right" title="מעבר לטבלת הנתונים" target="_blank" rel="noopener">📊</a>
    <h1>תיעוד התערבויות/תקיפות</h1>
  </div>

  <dialog id="infoModal">
    <div class="modal-head">
      <h3>ℹ️ איך ממלאים?</h3>
      <button class="close" onclick="infoModal.close()">✖</button>
    </div>
    <ol>
      <li>תאריך, קישור, תיאור קצר.</li>
      <li>פרק, תחומים, פלטפורמות.</li>
      <li>כותרות/תרגום, תוקף/יעד, מידת השפעה, סימוני כן/לא.</li>
      <li>שליחה. חותמת זמן תתווסף אוטומטית.</li>
    </ol>
  </dialog>

  <div class="container">
    <div id="corsWarning" class="warning"></div>

    <form id="form" class="card" novalidate>
      <input type="hidden" name="timestamp" id="timestampInput"/>

      <div class="grid cols-2">
        <label>
          <span>תאריך</span>
          <input type="date" name="date" id="dateInput" required>
          <small class="hint">לא ניתן לבחור תאריך עתידי.</small>
        </label>
        <label>
          <span>קישור</span>
          <input type="url" name="link" id="linkInput" required placeholder="https://example.com" pattern="https?://.+">
          <small class="hint">חובה http או https.</small>
        </label>
      </div>

      <div class="grid cols-2">
        <label>
          <span>כותרת</span>
          <input type="text" name="title" id="titleInput" placeholder="כותרת המקור (רצוי)">
        </label>
        <label>
          <span>כותרת בעברית</span>
          <input type="text" name="title_he" id="titleHeInput" placeholder="תרגום/ניסוח בעברית (לא חובה)">
        </label>
      </div>

      <div class="grid cols-2">
        <label>
          <span>תיאור קצר</span>
          <textarea name="summary" id="summaryInput" required minlength="5" maxlength="500" placeholder="תיאור תמציתי של האירוע"></textarea>
        </label>
        <label>
          <span>תרגום לעברית</span>
          <textarea name="translation_he" id="translationHeInput" placeholder="תרגום חופשי/נקודות בעברית (לא חובה)"></textarea>
        </label>
      </div>

      <div class="grid cols-2">
        <label>
          <span>הגוף התוקף</span>
          <input type="text" name="attacker" placeholder="ארגון/גוף/חשבון">
        </label>
        <label>
          <span>הגוף המותקף</span>
          <input type="text" name="target" placeholder="ארגון/גוף/יעד">
        </label>
      </div>

      <fieldset>
        <legend>פרק</legend>
        <select name="chapter" id="chapterSelect" required>
          <option value="" selected disabled>בחר...</option>
          <option>דוחות מחקר</option><option>מקומית</option><option>עולמית</option>
          <option>מדיניות ורגולציה</option><option>יוזמות אזרחיות</option><option>אחר</option>
        </select>
      </fieldset>

      <fieldset>
        <legend>תחום <span class="hint">בחירה מרובה</span></legend>
        <div class="toolbar">
          <button class="chipbtn" type="button" data-scope="domains" data-action="all">בחר הכל</button>
          <button class="chipbtn" type="button" data-scope="domains" data-action="none">נקה הכל</button>
        </div>
        <div class="checks" id="domainsBox">
          <label class="check"><input type="checkbox" name="domains[]" value="כלכלי">כלכלי</label>
          <label class="check"><input type="checkbox" name="domains[]" value="צבאי">צבאי</label>
          <label class="check"><input type="checkbox" name="domains[]" value="חברתי">חברתי</label>
          <label class="check"><input type="checkbox" name="domains[]" value="מדיני">מדיני</label>
          <label class="check"><input type="checkbox" name="domains[]" value="דתי">דתי</label>
          <label class="check"><input type="checkbox" name="domains[]" value="פוליטי">פוליטי</label>
          <label class="check"><input type="checkbox" name="domains[]" value="בינלאומי">בינלאומי</label>
          <label class="check"><input type="checkbox" name="domains[]" value="בחירות">בחירות</label>
          <label class="check"><input type="checkbox" name="domains[]" value="אחר">אחר</label>
          <label class="check"><input type="checkbox" name="domains[]" value="לא רלוונטי">לא רלוונטי</label>
        </div>
      </fieldset>

      <fieldset>
        <legend>פלטפורמות <span class="hint">בחירה מרובה</span></legend>
        <div class="toolbar">
          <button class="chipbtn" type="button" data-scope="platforms" data-action="all">בחר הכל</button>
          <button class="chipbtn" type="button" data-scope="platforms" data-action="none">נקה הכל</button>
        </div>
        <div class="checks" id="platformsBox">
          <label class="check"><input type="checkbox" name="platforms[]" value="פייסבוק">פייסבוק</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="יוטיוב">יוטיוב</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="אינסטגרם">אינסטגרם</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="טיקטוק">טיקטוק</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="טוויטר">טוויטר</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="טלגרם">טלגרם</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="אתרים ‐ Web">אתרים ‐ Web</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="ווטסאפ">ווטסאפ</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="צ'אט בוטים">צ'אט בוטים</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="gaming">gaming</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="וויקיפדיה">וויקיפדיה</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="קריפטו">קריפטו</label>
          <label class="check"><input type="checkbox" name="platforms[]" value="אחר">אחר</label>
        </div>
      </fieldset>

      <div class="grid cols-3">
        <label>
          <span>מידת השפעה</span>
          <select name="impact" id="impactSelect" required>
            <option value="נמוך">נמוך</option>
            <option value="בינוני" selected>בינוני</option>
            <option value="גבוה">גבוה</option>
            <option value="קריטי">קריטי</option>
            <option value="לא רלוונטי">לא רלוונטי</option>
          </select>
        </label>
        <label>
          <span>שימוש ב-AI</span>
          <select name="ai" id="aiSelect" required>
            <option value="כן">כן</option><option value="לא" selected>לא</option>
          </select>
        </label>
        <label>
          <span>קשור ל-בחירות</span>
          <select name="elections" id="electionsSelect" required>
            <option value="כן">כן</option><option value="לא" selected>לא</option>
          </select>
        </label>
      </div>

      <label>
        <span>קשור לישראל/יהודים</span>
        <select name="israel" id="israelSelect" required>
          <option value="כן">כן</option><option value="לא" selected>לא</option>
        </select>
      </label>

      <!-- הערות חופשיות -->
      <label>
        <span>הערות</span>
        <textarea name="notes" id="notesInput" placeholder="הוסף הערות חופשיות, פרטים נוספים, תיוגים פנימיים וכד' (לא חובה)"></textarea>
      </label>

      <button type="submit" id="submitBtn">שליחה</button>
      <p id="responseMessage"></p>
    </form>
  </div>

  <script>
    // ====== CONFIG ======
    // כתובת הפריסה החדשה
    const SCRIPT_URL_POST = 'https://script.google.com/macros/s/AKfycbxEXuY6-2gHbaO2N7cws-efoRpHILuPmSiMBT11ovAdezvkq_FyrqFMPsGeZ1kH0e46/exec';

    const isFileOrigin = (location.origin === 'null') || (location.protocol === 'file:');
    const corsWarning = document.getElementById('corsWarning');
    const formEl = document.getElementById('form');
    const responseEl = document.getElementById('responseMessage');

    // modal
    const infoModal = document.getElementById('infoModal');
    document.getElementById('openInfo').addEventListener('click', ()=> infoModal.showModal());

    // file:// warning
    if (isFileOrigin){
      corsWarning.style.display='block';
      corsWarning.innerHTML='⚠️ הקובץ פתוח מ־<code>file://</code> ולכן הדפדפן חוסם בקשות. פתח דרך שרת (localhost/Pages).';
    }

    // date default + max
    (function(){
      const d=new Date(), yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      const today=`${yyyy}-${mm}-${dd}`;
      const dateInput=document.getElementById('dateInput');
      if (dateInput){ dateInput.max=today; if(!dateInput.value) dateInput.value=today; }
    })();

    function showMsg(ok, text){
      responseEl.textContent = text;
      responseEl.className = ok ? 'success' : 'error';
      responseEl.style.display='block';
      responseEl.scrollIntoView({behavior:'smooth', block:'center'});
    }

    function validateForm(){
      responseEl.style.display='none'; responseEl.className='';
      const dateVal = document.getElementById('dateInput').value;
      const linkVal = document.getElementById('linkInput').value.trim();
      const summaryVal = document.getElementById('summaryInput').value.trim();
      const chapterVal = document.getElementById('chapterSelect').value;
      const impactVal = document.getElementById('impactSelect').value;
      const aiVal = document.getElementById('aiSelect').value;
      const electionsVal = document.getElementById('electionsSelect').value;
      const israelVal = document.getElementById('israelSelect').value;

      const today=new Date(); today.setHours(0,0,0,0);
      const picked=new Date(dateVal); picked.setHours(0,0,0,0);

      if(!dateVal){ showMsg(false,'יש למלא תאריך.'); return false; }
      if(picked>today){ showMsg(false,'תאריך עתידי אינו מותר.'); return false; }
      if(!/^https?:\/\/.+/i.test(linkVal)){ showMsg(false,'הקישור חייב להתחיל ב-http או https.'); return false; }
      if(!summaryVal || summaryVal.length<5){ showMsg(false,'תיאור קצר קצר מדי.'); return false; }
      if(!chapterVal){ showMsg(false,'יש לבחור פרק.'); return false; }
      if(!impactVal || !aiVal || !electionsVal || !israelVal){ showMsg(false,'יש להשלים את שדות כן/לא ומידת ההשפעה.'); return false; }
      return true;
    }

    // build payload including arrays
    function buildPayload(form){
      const fd=new FormData(form);
      const params=new URLSearchParams();

      for(const [k,v] of fd.entries()){
        if(k.endsWith('[]')) continue;
        params.append(k,v);
      }
      form.querySelectorAll('input[name="domains[]"]:checked').forEach(cb=>params.append('domains[]', cb.value));
      form.querySelectorAll('input[name="platforms[]"]:checked').forEach(cb=>params.append('platforms[]', cb.value));
      return params;
    }

    // Select all / none
    function toggleGroup(scope, action){
      const sel = scope==='domains' ? 'input[name="domains[]"]' : 'input[name="platforms[]"]';
      document.querySelectorAll(sel).forEach(cb => cb.checked = (action==='all'));
    }
    document.querySelectorAll('.chipbtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        toggleGroup(btn.dataset.scope, btn.dataset.action);
      });
    });

    // submit
    formEl.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(isFileOrigin) return showMsg(false,'אי אפשר לשלוח מתוך file://. פתח דרך http/https.');
      if(!validateForm()) return;

      // client timestamp
      const now=new Date(), pad=n=>String(n).padStart(2,'0');
      const ts=`${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      document.getElementById('timestampInput').value = ts;

      const payload = buildPayload(formEl);
      const inputs = formEl.querySelectorAll('input, select, textarea, button');
      inputs.forEach(el=>el.disabled=true);

      fetch(SCRIPT_URL_POST, {
        method:'POST',
        mode:'no-cors',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body: payload.toString()
      })
      .then(()=>{ showMsg(true,'✅ נשלח. וודא שנוספה שורה בגיליון.'); formEl.reset();
        document.getElementById('dateInput').value = new Date().toISOString().slice(0,10);
      })
      .catch(err=>{ console.error(err); showMsg(false,'❌ שגיאה בשליחה. בדוק חיבור/הרשאות/פריסה.'); })
      .finally(()=> setTimeout(()=> inputs.forEach(el=>el.disabled=false), 900));
    });
  </script>
</body>
</html>
